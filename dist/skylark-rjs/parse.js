/**
 * skylark-rjs - A version of rjs that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./esprima","./lang"],function(esprima,lang){"use strict";function arrayToString(e){var n="[";return e&&e.forEach(function(e,r){n+=(0<r?",":"")+'"'+lang.jsEscape(e)+'"'}),n+="]"}var argPropName="arguments",emptyScope={},mixin=lang.mixin,hasProp=lang.hasProp;function traverse(e,r){var n;if(e){if(!1===r.call(null,e))return!1;for(var t=0,i=Object.keys(e);t<i.length;t++)if("object"==typeof(n=e[i[t]])&&null!==n&&!1===traverse(n,r))return!1}}function traverseBroad(e,r){var n;if(e){if(!1===r.call(null,e))return!1;for(var t=0,i=Object.keys(e);t<i.length;t++)"object"==typeof(n=e[key])&&null!==n&&traverseBroad(n,r)}}function getValidDeps(e){var r;if(e&&"ArrayExpression"===e.type&&e.elements)return r=[],e.elements.some(function(e){"Literal"===e.type&&r.push(e.value)}),r.length?r:void 0}function isFnExpression(e){return e&&("FunctionExpression"===e.type||"ArrowFunctionExpression"===e.type)}function parse(o,e,r,p){p=p||{};var n,t,i,l=[],a="",u=[],f=!0,r=esprima.parse(r);if(parse.recurse(r,function(e,r,n,t,i,a,s){return t=t||[],"define"!==e||n&&n!==o||(f=!1),n?u.push({name:n,deps:t}):l=l.concat(t),"define"===e&&a&&hasProp(s,a)?a:!!p.findNestedDependencies},p),p.insertNeedsDefine&&f&&(a+='require.needsDefine("'+o+'");'),l.length||u.length){for(n=0;n<u.length;n++)a&&(a+="\n"),(t=u[n]).name===o&&(t.deps=t.deps.concat(l),l=[]),i=arrayToString(t.deps),a+='define("'+t.name+'",'+i+");";l.length&&(a&&(a+="\n"),i=arrayToString(l),a+='define("'+o+'",'+i+");")}return a||null}return parse.traverse=traverse,parse.traverseBroad=traverseBroad,parse.isFnExpression=isFnExpression,parse.recurse=function(e,r,n,t){var i,a,s,o,p,l,u,f=n&&n.has;if(t=t||emptyScope,e)if(f&&"IfStatement"===e.type&&e.test.type&&"Literal"===e.test.type)e.test.value?this.recurse(e.consequent,r,n,t):this.recurse(e.alternate,r,n,t);else if(!1!==(s=this.parseNode(e,r,t))){if("string"==typeof s)return s;if("ExpressionStatement"===e.type&&e.expression&&"CallExpression"===e.expression.type&&e.expression.callee&&isFnExpression(e.expression.callee)&&(u=e.expression.callee),(u="UnaryExpression"===e.type&&e.argument&&"CallExpression"===e.argument.type&&e.argument.callee&&isFnExpression(e.argument.callee)?e.argument.callee:u)&&u.params&&u.params.length)for(p=u.params,t=mixin({},t,!0),o=0;o<p.length;o++)"Identifier"===(l=p[o]).type&&(t[l.name]=!0);for(o=0,i=Object.keys(e);o<i.length&&("object"!=typeof(a=e[i[o]])||null===a||"string"!=typeof(s=this.recurse(a,r,n,t))||!hasProp(t,s));o++);return"string"==typeof s&&hasProp(t,s)?s:void 0}},parse.definesRequire=function(e,r){var n=!1,t=!1;return traverse(esprima.parse(r),function(e){if((n="Program"===e.type&&e.body&&e.body.length?e.body.some(function(e){if("VariableDeclaration"===e.type){var r=e.declarations;if(r)if(r.some(function(e){return"VariableDeclarator"===e.type&&e.id&&"Identifier"===e.id.type&&"define"===e.id.name}))return!0}if("FunctionDeclaration"===e.type&&e.id&&"Identifier"===e.id.type&&"define"===e.id.name)return!0}):n)&&parse.hasDefineAmd(e))return!(t=!0)}),n&&t},parse.getAnonDeps=function(e,r){r="string"==typeof r?esprima.parse(r):r,r=this.findAnonDefineFactory(r);return parse.getAnonDepsFromNode(r)},parse.getAnonDepsFromNode=function(e){var r=[];return r=e&&(this.findRequireDepNames(e,r),e=e.params&&e.params.length)?(1<e?["require","exports","module"]:["require"]).concat(r):r},parse.isDefineNodeWithArgs=function(e){return e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"define"===e.callee.name&&e[argPropName]},parse.findAnonDefineFactory=function(e){var n;return traverse(e,function(e){var r;if(parse.isDefineNodeWithArgs(e))return isFnExpression(r=e[argPropName][0])?(n=r,!1):(e=e[argPropName][1],"Literal"===r.type&&isFnExpression(e)?(n=e,!1):void 0)}),n},parse.findConfig=function(fileContents){var jsConfig,foundConfig,stringData,foundRange,quote,quoteMatch,quoteRegExp=/(:\s|\[\s*)(['"])/,astRoot=esprima.parse(fileContents,{loc:!0});return traverse(astRoot,function(e){var r,n=parse.hasRequire(e);if(!n||"require"!==n&&"requirejs"!==n&&"requireConfig"!==n&&"requirejsConfig"!==n){if(r=parse.getRequireObjectLiteral(e))return stringData=parse.nodeToString(fileContents,r),jsConfig=stringData.value,foundRange=stringData.range,!1}else if((r=e[argPropName]&&e[argPropName][0])&&"ObjectExpression"===r.type)return stringData=parse.nodeToString(fileContents,r),jsConfig=stringData.value,foundRange=stringData.range,!1}),jsConfig&&(quoteMatch=quoteRegExp.exec(jsConfig),quote=quoteMatch&&quoteMatch[2]||'"',foundConfig=eval("("+jsConfig+")")),{config:foundConfig,range:foundRange,quote:quote}},parse.getRequireObjectLiteral=function(e){if(e.id&&"Identifier"===e.id.type&&("require"===e.id.name||"requirejs"===e.id.name)&&e.init&&"ObjectExpression"===e.init.type)return e.init},parse.renameNamespace=function(e,t){var i,a=[],r=esprima.parse(e,{loc:!0});return parse.recurse(r,function(e,r,n,t,i){return a.push(i.loc),"define"!==e},{}),a.length&&(i=e.split("\n"),a.reverse(),a.forEach(function(e){var r=e.start.column,e=e.start.line-1,n=i[e];i[e]=n.substring(0,r)+t+"."+n.substring(r,n.length)}),e=i.join("\n")),e},parse.findDependencies=function(e,r,n){var i=[],r=esprima.parse(r);return parse.recurse(r,function(e,r,n,t){t&&(i=i.concat(t))},n),i},parse.findCjsDependencies=function(e,r){var n=[];return traverse(esprima.parse(r),function(e){e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"require"===e.callee.name&&e[argPropName]&&1===e[argPropName].length&&"Literal"===(e=e[argPropName][0]).type&&n.push(e.value)}),n},parse.hasDefDefine=function(e){return"FunctionDeclaration"===e.type&&e.id&&"Identifier"===e.id.type&&"define"===e.id.name},parse.hasDefineAmd=function(e){return e&&"AssignmentExpression"===e.type&&e.left&&"MemberExpression"===e.left.type&&e.left.object&&"define"===e.left.object.name&&e.left.property&&"amd"===e.left.property.name},parse.refsDefineAmd=function(e){return e&&"MemberExpression"===e.type&&e.object&&"define"===e.object.name&&"Identifier"===e.object.type&&e.property&&"amd"===e.property.name&&"Identifier"===e.property.type},parse.hasRequire=function(e){var r,n=e&&e.callee;return e&&"CallExpression"===e.type&&n&&("Identifier"!==n.type||"require"!==n.name&&"requirejs"!==n.name?"MemberExpression"===n.type&&n.object&&"Identifier"===n.object.type&&("require"===n.object.name||"requirejs"===n.object.name)&&n.property&&"config"===n.property.name&&(r=n.object.name+"Config"):r=n.name),r},parse.hasDefine=function(e){return e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"define"===e.callee.name},parse.getNamedDefine=function(e){var r;return traverse(esprima.parse(e),function(e){if(e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"define"===e.callee.name&&e[argPropName]&&e[argPropName][0]&&"Literal"===e[argPropName][0].type)return r=e[argPropName][0].value,!1}),r},parse.getAllNamedDefines=function(e,o){var p=[];return parse.recurse(esprima.parse(e),function(e,r,n,t,i,a,s){return"define"===e&&n&&!o.hasOwnProperty(n)&&p.push(n),"define"!==e||!a||!hasProp(s,a)||a},{}),p},parse.usesAmdOrRequireJs=function(e,r){var i;return traverse(esprima.parse(r),function(e){var r,n,t;parse.hasDefDefine(e)?r="declaresDefine":parse.hasDefineAmd(e)?r="defineAmd":(n=parse.hasRequire(e))?!(t=e[argPropName]&&e[argPropName][0])||"ObjectExpression"!==t.type&&"ArrayExpression"!==t.type||(r=n):parse.hasDefine(e)&&(r="define"),r&&((i=i||{})[r]=!0)}),i},parse.usesCommonJs=function(e,r){var t=null,i=!1;return traverse(esprima.parse(r),function(e){var r,n=e.expression||e.init;"Identifier"!==e.type||"__dirname"!==e.name&&"__filename"!==e.name?"VariableDeclarator"===e.type&&e.id&&"Identifier"===e.id.type&&"exports"===e.id.name?r="varExports":n&&"AssignmentExpression"===n.type&&n.left&&"MemberExpression"===n.left.type&&n.left.object?"module"===n.left.object.name&&n.left.property&&"exports"===n.left.property.name?r="moduleExports":"exports"===n.left.object.name&&n.left.property?r="exports":"MemberExpression"===n.left.object.type&&"module"===n.left.object.object.name&&"exports"===n.left.object.property.name&&"Identifier"===n.left.object.property.type&&(r="moduleExports"):e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"require"===e.callee.name&&e[argPropName]&&1===e[argPropName].length&&"Literal"===e[argPropName][0].type&&(r="require"):r=e.name.substring(2),r&&("varExports"===r?i=!0:"exports"===r&&i||((t=t||{})[r]=!0))}),t},parse.findRequireDepNames=function(e,r){traverse(e,function(e){e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"require"===e.callee.name&&e[argPropName]&&1===e[argPropName].length&&"Literal"===(e=e[argPropName][0]).type&&r.push(e.value)})},parse.parseNode=function(e,r,n){var t,i,a,s=e&&e[argPropName],o=parse.hasRequire(e),p=!1;if("require"===o||"requirejs"===o){if(t=getValidDeps(o=(o=e[argPropName]&&e[argPropName][0])&&"ArrayExpression"!==o.type&&"ObjectExpression"===o.type?e[argPropName][1]:o))return r("require",null,null,t,e)}else{if(parse.hasDefine(e)&&s&&s.length){if(o=s[0],t=s[1],i=s[2],"ArrayExpression"===o.type?(i=t,t=o,o=null):isFnExpression(o)?(i=o,o=t=null):"Identifier"===o.type&&1===s.length&&hasProp(n,o.name)?(p=!0,i=o,o=null):"Literal"!==o.type&&(o=t=i=null),o&&"Literal"===o.type&&t&&(isFnExpression(t)?(i=t,t=null):"ObjectExpression"===t.type?t=i=null:"Identifier"===t.type&&(2===s.length?t=i=null:3===s.length&&isFnExpression(i)&&(t=null))),t&&"ArrayExpression"===t.type)t=getValidDeps(t);else if(isFnExpression(i))(s=parse.getAnonDepsFromNode(i)).length&&(t=s);else if(t||i&&!p)return;return r("define",null,o=o&&"Literal"===o.type?o.value:o,t,e,i&&"Identifier"===i.type?i.name:void 0,n)}if("CallExpression"===e.type&&e.callee&&isFnExpression(e.callee)&&e.callee.body&&e.callee.body.body&&1===e.callee.body.body.length&&"IfStatement"===e.callee.body.body[0].type&&(s=e.callee.body.body[0]).consequent&&s.consequent.body&&"ExpressionStatement"===(p=s.consequent.body[0]).type&&p.expression&&parse.hasDefine(p.expression)&&p.expression.arguments&&1===p.expression.arguments.length&&"Identifier"===p.expression.arguments[0].type&&(traverse(s.test,function(e){if(parse.refsDefineAmd(e))return!(a=!0)}),a))return r("define",null,null,null,p.expression,p.expression.arguments[0].name,n)}},parse.nodeToString=function(e,r){var r=r.loc,e=e.split("\n"),n=(1<r.start.line?e.slice(0,r.start.line-1).join("\n")+"\n":"")+e[r.start.line-1].substring(0,r.start.column),e=r.start.line===r.end.line?e[r.start.line-1].substring(r.start.column,r.end.column):e[r.start.line-1].substring(r.start.column)+"\n"+e.slice(r.start.line,r.end.line-1).join("\n")+"\n"+e[r.end.line-1].substring(0,r.end.column);return{value:e,range:[n.length,n.length+e.length]}},parse.getLicenseComments=function(e,r){var n,t,i,a,s,o,p=esprima.parse(r,{comment:!0,range:!0}),l="",u={},f=-1===r.indexOf("\r")?"\n":"\r\n";if(p.comments)for(s=0;s<p.comments.length;s++){if("Line"===(n=p.comments[s]).type)if(a="//"+n.value+f,t=n,s+1>=p.comments.length)a+=f;else{for(o=s+1;o<p.comments.length&&("Line"===(i=p.comments[o]).type&&i.range[0]===t.range[1]+1);o++)a+="//"+i.value+f,t=i;a+=f,s=o-1}else a="/*"+n.value+"*/"+f+f;u[a]||-1===a.indexOf("license")&&("Block"!==n.type||0!==a.indexOf("/*!"))&&-1===a.indexOf("opyright")&&-1===a.indexOf("(c)")||(l+=a,u[a]=!0)}return l},parse});
//# sourceMappingURL=sourcemaps/parse.js.map
