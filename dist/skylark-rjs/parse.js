/**
 * skylark-rjs - A version of rjs that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./esprima","./lang"],function(esprima,lang){"use strict";function arrayToString(e){var r="[";return e&&e.forEach(function(e,n){r+=(n>0?",":"")+'"'+lang.jsEscape(e)+'"'}),r+="]"}var argPropName="arguments",emptyScope={},mixin=lang.mixin,hasProp=lang.hasProp;function traverse(e,r){var n;if(e){if(!1===r.call(null,e))return!1;for(var t=0,a=Object.keys(e);t<a.length;t++)if("object"==typeof(n=e[a[t]])&&null!==n&&!1===traverse(n,r))return!1}}function traverseBroad(e,r){var n;if(e){if(!1===r.call(null,e))return!1;for(var t=0,a=Object.keys(e);t<a.length;t++)"object"==typeof(n=e[key])&&null!==n&&traverseBroad(n,r)}}function getValidDeps(e){if(e&&"ArrayExpression"===e.type&&e.elements){var r=[];return e.elements.some(function(e){"Literal"===e.type&&r.push(e.value)}),r.length?r:void 0}}function isFnExpression(e){return e&&("FunctionExpression"===e.type||"ArrowFunctionExpression"===e.type)}function parse(e,r,n,t){t=t||{};var a,i,s,o=[],p="",l=[],u=!0,f=esprima.parse(n);if(parse.recurse(f,function(r,n,a,i,s,p,f){return i||(i=[]),"define"!==r||a&&a!==e||(u=!1),a?l.push({name:a,deps:i}):o=o.concat(i),"define"===r&&p&&hasProp(f,p)?p:!!t.findNestedDependencies},t),t.insertNeedsDefine&&u&&(p+='require.needsDefine("'+e+'");'),o.length||l.length){for(a=0;a<l.length;a++)i=l[a],p&&(p+="\n"),i.name===e&&(i.deps=i.deps.concat(o),o=[]),s=arrayToString(i.deps),p+='define("'+i.name+'",'+s+");";o.length&&(p&&(p+="\n"),s=arrayToString(o),p+='define("'+e+'",'+s+");")}return p||null}return parse.traverse=traverse,parse.traverseBroad=traverseBroad,parse.isFnExpression=isFnExpression,parse.recurse=function(e,r,n,t){var a,i,s,o,p,l,u,f=n&&n.has;if(t=t||emptyScope,e)if(f&&"IfStatement"===e.type&&e.test.type&&"Literal"===e.test.type)e.test.value?this.recurse(e.consequent,r,n,t):this.recurse(e.alternate,r,n,t);else{if(!1===(s=this.parseNode(e,r,t)))return;if("string"==typeof s)return s;if("ExpressionStatement"===e.type&&e.expression&&"CallExpression"===e.expression.type&&e.expression.callee&&isFnExpression(e.expression.callee)&&(u=e.expression.callee),"UnaryExpression"===e.type&&e.argument&&"CallExpression"===e.argument.type&&e.argument.callee&&isFnExpression(e.argument.callee)&&(u=e.argument.callee),u&&u.params&&u.params.length)for(p=u.params,t=mixin({},t,!0),o=0;o<p.length;o++)"Identifier"===(l=p[o]).type&&(t[l.name]=!0);for(o=0,a=Object.keys(e);o<a.length&&("object"!=typeof(i=e[a[o]])||null===i||"string"!=typeof(s=this.recurse(i,r,n,t))||!hasProp(t,s));o++);if("string"==typeof s)return hasProp(t,s)?s:void 0}},parse.definesRequire=function(e,r){var n=!1,t=!1;return traverse(esprima.parse(r),function(e){if("Program"===e.type&&e.body&&e.body.length&&(n=e.body.some(function(e){if("VariableDeclaration"===e.type){var r=e.declarations;if(r)if(r.some(function(e){return"VariableDeclarator"===e.type&&e.id&&"Identifier"===e.id.type&&"define"===e.id.name}))return!0}if("FunctionDeclaration"===e.type&&e.id&&"Identifier"===e.id.type&&"define"===e.id.name)return!0})),n&&parse.hasDefineAmd(e))return t=!0,!1}),n&&t},parse.getAnonDeps=function(e,r){var n="string"==typeof r?esprima.parse(r):r,t=this.findAnonDefineFactory(n);return parse.getAnonDepsFromNode(t)},parse.getAnonDepsFromNode=function(e){var r,n=[];return e&&(this.findRequireDepNames(e,n),(r=e.params&&e.params.length)&&(n=(r>1?["require","exports","module"]:["require"]).concat(n))),n},parse.isDefineNodeWithArgs=function(e){return e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"define"===e.callee.name&&e[argPropName]},parse.findAnonDefineFactory=function(e){var r;return traverse(e,function(e){var n,t;if(parse.isDefineNodeWithArgs(e)){if(isFnExpression(n=e[argPropName][0]))return r=n,!1;if(t=e[argPropName][1],"Literal"===n.type&&isFnExpression(t))return r=t,!1}}),r},parse.findConfig=function(fileContents){var jsConfig,foundConfig,stringData,foundRange,quote,quoteMatch,quoteRegExp=/(:\s|\[\s*)(['"])/,astRoot=esprima.parse(fileContents,{loc:!0});return traverse(astRoot,function(e){var r,n=parse.hasRequire(e);if(!n||"require"!==n&&"requirejs"!==n&&"requireConfig"!==n&&"requirejsConfig"!==n){if(r=parse.getRequireObjectLiteral(e))return stringData=parse.nodeToString(fileContents,r),jsConfig=stringData.value,foundRange=stringData.range,!1}else if((r=e[argPropName]&&e[argPropName][0])&&"ObjectExpression"===r.type)return stringData=parse.nodeToString(fileContents,r),jsConfig=stringData.value,foundRange=stringData.range,!1}),jsConfig&&(quoteMatch=quoteRegExp.exec(jsConfig),quote=quoteMatch&&quoteMatch[2]||'"',foundConfig=eval("("+jsConfig+")")),{config:foundConfig,range:foundRange,quote:quote}},parse.getRequireObjectLiteral=function(e){if(e.id&&"Identifier"===e.id.type&&("require"===e.id.name||"requirejs"===e.id.name)&&e.init&&"ObjectExpression"===e.init.type)return e.init},parse.renameNamespace=function(e,r){var n,t=[],a=esprima.parse(e,{loc:!0});return parse.recurse(a,function(e,r,n,a,i){return t.push(i.loc),"define"!==e},{}),t.length&&(n=e.split("\n"),t.reverse(),t.forEach(function(e){var t=e.start.column,a=e.start.line-1,i=n[a];n[a]=i.substring(0,t)+r+"."+i.substring(t,i.length)}),e=n.join("\n")),e},parse.findDependencies=function(e,r,n){var t=[],a=esprima.parse(r);return parse.recurse(a,function(e,r,n,a){a&&(t=t.concat(a))},n),t},parse.findCjsDependencies=function(e,r){var n=[];return traverse(esprima.parse(r),function(e){var r;e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"require"===e.callee.name&&e[argPropName]&&1===e[argPropName].length&&"Literal"===(r=e[argPropName][0]).type&&n.push(r.value)}),n},parse.hasDefDefine=function(e){return"FunctionDeclaration"===e.type&&e.id&&"Identifier"===e.id.type&&"define"===e.id.name},parse.hasDefineAmd=function(e){return e&&"AssignmentExpression"===e.type&&e.left&&"MemberExpression"===e.left.type&&e.left.object&&"define"===e.left.object.name&&e.left.property&&"amd"===e.left.property.name},parse.refsDefineAmd=function(e){return e&&"MemberExpression"===e.type&&e.object&&"define"===e.object.name&&"Identifier"===e.object.type&&e.property&&"amd"===e.property.name&&"Identifier"===e.property.type},parse.hasRequire=function(e){var r,n=e&&e.callee;return e&&"CallExpression"===e.type&&n&&("Identifier"!==n.type||"require"!==n.name&&"requirejs"!==n.name?"MemberExpression"===n.type&&n.object&&"Identifier"===n.object.type&&("require"===n.object.name||"requirejs"===n.object.name)&&n.property&&"config"===n.property.name&&(r=n.object.name+"Config"):r=n.name),r},parse.hasDefine=function(e){return e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"define"===e.callee.name},parse.getNamedDefine=function(e){var r;return traverse(esprima.parse(e),function(e){if(e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"define"===e.callee.name&&e[argPropName]&&e[argPropName][0]&&"Literal"===e[argPropName][0].type)return r=e[argPropName][0].value,!1}),r},parse.getAllNamedDefines=function(e,r){var n=[];return parse.recurse(esprima.parse(e),function(e,t,a,i,s,o,p){return"define"===e&&a&&(r.hasOwnProperty(a)||n.push(a)),"define"!==e||!o||!hasProp(p,o)||o},{}),n},parse.usesAmdOrRequireJs=function(e,r){var n;return traverse(esprima.parse(r),function(e){var r,t,a;parse.hasDefDefine(e)?r="declaresDefine":parse.hasDefineAmd(e)?r="defineAmd":(t=parse.hasRequire(e))?!(a=e[argPropName]&&e[argPropName][0])||"ObjectExpression"!==a.type&&"ArrayExpression"!==a.type||(r=t):parse.hasDefine(e)&&(r="define"),r&&(n||(n={}),n[r]=!0)}),n},parse.usesCommonJs=function(e,r){var n=null,t=!1;return traverse(esprima.parse(r),function(e){var r,a=e.expression||e.init;"Identifier"!==e.type||"__dirname"!==e.name&&"__filename"!==e.name?"VariableDeclarator"===e.type&&e.id&&"Identifier"===e.id.type&&"exports"===e.id.name?r="varExports":a&&"AssignmentExpression"===a.type&&a.left&&"MemberExpression"===a.left.type&&a.left.object?"module"===a.left.object.name&&a.left.property&&"exports"===a.left.property.name?r="moduleExports":"exports"===a.left.object.name&&a.left.property?r="exports":"MemberExpression"===a.left.object.type&&"module"===a.left.object.object.name&&"exports"===a.left.object.property.name&&"Identifier"===a.left.object.property.type&&(r="moduleExports"):e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"require"===e.callee.name&&e[argPropName]&&1===e[argPropName].length&&"Literal"===e[argPropName][0].type&&(r="require"):r=e.name.substring(2),r&&("varExports"===r?t=!0:"exports"===r&&t||(n||(n={}),n[r]=!0))}),n},parse.findRequireDepNames=function(e,r){traverse(e,function(e){var n;e&&"CallExpression"===e.type&&e.callee&&"Identifier"===e.callee.type&&"require"===e.callee.name&&e[argPropName]&&1===e[argPropName].length&&"Literal"===(n=e[argPropName][0]).type&&r.push(n.value)})},parse.parseNode=function(e,r,n){var t,a,i,s,o,p,l,u,f=e&&e[argPropName],c=parse.hasRequire(e),m=!1;if("require"===c||"requirejs"===c){if((s=e[argPropName]&&e[argPropName][0])&&"ArrayExpression"!==s.type&&"ObjectExpression"===s.type&&(s=e[argPropName][1]),!(a=getValidDeps(s)))return;return r("require",null,null,a,e)}if(parse.hasDefine(e)&&f&&f.length){if(t=f[0],a=f[1],o=f[2],"ArrayExpression"===t.type?(o=a,a=t,t=null):isFnExpression(t)?(o=t,t=a=null):"Identifier"===t.type&&1===f.length&&hasProp(n,t.name)?(m=!0,o=t,t=null):"Literal"!==t.type&&(t=a=o=null),t&&"Literal"===t.type&&a&&(isFnExpression(a)?(o=a,a=null):"ObjectExpression"===a.type?a=o=null:"Identifier"===a.type&&(2===f.length?a=o=null:3===f.length&&isFnExpression(o)&&(a=null))),a&&"ArrayExpression"===a.type)a=getValidDeps(a);else if(isFnExpression(o))(i=parse.getAnonDepsFromNode(o)).length&&(a=i);else if(a||o&&!m)return;return t&&"Literal"===t.type&&(t=t.value),r("define",null,t,a,e,o&&"Identifier"===o.type?o.name:void 0,n)}if("CallExpression"===e.type&&e.callee&&isFnExpression(e.callee)&&e.callee.body&&e.callee.body.body&&1===e.callee.body.body.length&&"IfStatement"===e.callee.body.body[0].type&&(u=e.callee.body.body[0]).consequent&&u.consequent.body&&"ExpressionStatement"===(p=u.consequent.body[0]).type&&p.expression&&parse.hasDefine(p.expression)&&p.expression.arguments&&1===p.expression.arguments.length&&"Identifier"===p.expression.arguments[0].type&&(traverse(u.test,function(e){if(parse.refsDefineAmd(e))return l=!0,!1}),l))return r("define",null,null,null,p.expression,p.expression.arguments[0].name,n)},parse.nodeToString=function(e,r){var n,t=r.loc,a=e.split("\n"),i=(t.start.line>1?a.slice(0,t.start.line-1).join("\n")+"\n":"")+a[t.start.line-1].substring(0,t.start.column);return{value:n=t.start.line===t.end.line?a[t.start.line-1].substring(t.start.column,t.end.column):a[t.start.line-1].substring(t.start.column)+"\n"+a.slice(t.start.line,t.end.line-1).join("\n")+"\n"+a[t.end.line-1].substring(0,t.end.column),range:[i.length,i.length+n.length]}},parse.getLicenseComments=function(e,r){var n,t,a,i,s,o,p=esprima.parse(r,{comment:!0,range:!0}),l="",u={},f=-1===r.indexOf("\r")?"\n":"\r\n";if(p.comments)for(s=0;s<p.comments.length;s++){if("Line"===(n=p.comments[s]).type)if(i="//"+n.value+f,t=n,s+1>=p.comments.length)i+=f;else{for(o=s+1;o<p.comments.length&&("Line"===(a=p.comments[o]).type&&a.range[0]===t.range[1]+1);o++)i+="//"+a.value+f,t=a;i+=f,s=o-1}else i="/*"+n.value+"*/"+f+f;u[i]||-1===i.indexOf("license")&&("Block"!==n.type||0!==i.indexOf("/*!"))&&-1===i.indexOf("opyright")&&-1===i.indexOf("(c)")||(l+=i,u[i]=!0)}return l},parse});
//# sourceMappingURL=sourcemaps/parse.js.map
